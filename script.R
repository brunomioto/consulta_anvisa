
# packages ----------------------------------------------------------------

library(httr)
library(dplyr)
library(purrr)
library(progress)
# api ---------------------------------------------------------------------

#maquira 05823205000190
#ingamed 04037992000344
#pfizer  46070868003699
#3m      45985371000108

consulta_anvisa <- function(cnpj){

pb <- progress_bar$new(total = 100)
pb$tick()
# Parâmetros
query <- list(
  "count" = 10000,
  "filter[cnpj]" = cnpj,
  "page" = 1
)

# Fazer requisição
resp <- httr::GET(
  "https://consultas.anvisa.gov.br/api/consulta/saude",
  query = query,
  httr::add_headers("Authorization" = "Guest")
)

# Content
resultado <- httr::content(resp)

# Data wrangling

if(length(resultado$content) > 0){
df <- data.frame(matrix(unlist(resultado$content), 
                        nrow=length(resultado$content), 
                        byrow=TRUE)) %>% 
  dplyr::rename("processo" = 1,
                "cnpj" = 2,
                "razao_social" = 3,
                "produto" = 4,
                "negativo" = 5,
                "registro" = 6,
                "situacao" = 7) #%>% 
  #dplyr::slice_tail(n = 5)
}else{
 df <- NULL
}

# Dataframe
return(df)

}


# Lista de empresas
#empresas <- c("05823205000190", #maquira
#              "04037992000344" #ingamed
#              )

empresas <- stringr::str_remove_all(
  c(
  "20.180.587/0001-75",
  "20.212.019/0001-09",
  "27.751.050/0001-67",
  "45.985.371/0001-08",
  "02.543.673/0001-13",
  "64.602.097/0001-95",
  "02.062.507/0001-03",
  "00.257.992/0001-37",
  "60.858.552/0002-48",
  "01.786.547/0001-27",
  "61.374.161/0001-30",
  "84.833.888/0001-33",
  "04.741.630/0001-78",
  "03.075.426/0001-00",
  "02.913.684/0001-48",
  "02.913.684/0001-48",
  "73.191.090/0001-19",
  "05.167.642/0001-01",
  "17.106.938/0001-93",
  "00.233.695/0001-51",
  "82.641.325/0001-18",
  "08.444.319/0001-18",
  "27.896.650/0001-13",
  "65.441.255/0001-35",
  "01.101.363/0001-86",
  "25.265.400/0001-50",
  "66.818.360/0001-03",
  "05.106.945/0001-06",
  "31.116.239/0001-55",
  
  "00.013.609/0001-03",
  "33.112.665/0001-46",
  "02.827.605/0001-86",
  "11.812.152/0001-05",
  "22.144.369/0001-00",
  "60.383.338/0001-00",
  "05.741.680/0001-18",
  "74.017.708/0001-91",
  "72.953.003/0001-50",
  "04.004.675/0001-60",
  "29.395.902/0001-56",
  "71.029.631/0001-81",
  "00.489.050/0001-84",
  "84.683.556/0001-10",
  "48.708.010/0001-02",
  "08.954.683/0001-28",
  "60.397.965/0001-91",
  "12.568.799/0001-04",
  "02.039.112/0001-81",
  "01.780.791/0001-82",
  "58.949.579/0001-13",
  "07.740.586/0001-70",
  "17.910.389/0001-05",
  "12.472.927/0001-03",
  "13.612.214/0001-60",
  "23.331.027/0001-62",
  "00.015.955/0001-12",
  "06.019.906/0001-34",
  
  "04.298.106/0001-74",
  "12.483.930/0001-22",
  "07.707.681/0001-71",
  "68.567.650/0001-57",
  "03.141.310/0001-14",
  "81.591.786/0001-60",
  "06.295.846/0001-82",
  "33.425.331/0005-56",
  "33.425.331/0001-22",
  "33.425.331/0005-56",
  "05.915.452/0001-17",
  "57.478.612/0001-01",
  "01.074.837/0001-48", 
  "16.970.346/0001-52",
  
  
  "31.984.510/0001-74" 
  
  
),
"\\.|\\/|-")

#empresas
teste <- consulta_anvisa("05823205000190")

# Consulta
resultados_consulta <- purrr::map(.x = empresas,
                                  .f = consulta_anvisa,
                                  .progress = TRUE) %>% 
  compact() %>% 
  list_rbind()


writexl::write_xlsx(resultados_consulta, paste("completo_resultados_consulta_",Sys.Date(),".xlsx"))

